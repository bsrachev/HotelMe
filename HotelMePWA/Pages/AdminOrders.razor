@page "/admin/orders"
@using HotelMe.Shared.Models
@inject OrderService OrderService
@inject AuthService AuthService

<MudText Typo="Typo.h5" Class="mb-2">📦 All Orders (Admin)</MudText>

@if (!isReady)
{
    <MudProgressCircular Indeterminate="true" Class="my-4" />
}
else if (!isAdmin)
{
    <MudText Color="Color.Error">⛔ Only admins can view this.</MudText>
}
else if (orders.Count == 0)
{
    <MudText Color="Color.Secondary">No orders yet.</MudText>
}
else
{
    <MudTable Items="orders" Elevation="1" Dense="true">
        <HeaderContent>
            <MudTh>#</MudTh>
            <MudTh>Room</MudTh>
            <MudTh>Items</MudTh>
            <MudTh>Created</MudTh>
            <MudTh>Status</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="#">@context.Id</MudTd>
            <MudTd DataLabel="Room">@(context.RoomNumber ?? "—")</MudTd>
            <MudTd DataLabel="Items">@context.ItemsSummary</MudTd>
            <MudTd DataLabel="Created">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
            <MudTd DataLabel="Status">@context.Status</MudTd>
            <MudTd DataLabel="">
                @if (context.Status == "Pending")
                {
                    <MudButton Color="Color.Success" Variant="Variant.Filled" Size="Size.Small" OnClick="() => Complete(context.Id)">Complete</MudButton>
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private bool isAdmin, isReady;
    private List<Order> orders = new();

    protected override async Task OnInitializedAsync()
    {
        var role = await AuthService.GetUserRole();
        isAdmin = role == "Admin";

        if (isAdmin)
            orders = await OrderService.GetAllOrders();

        isReady = true;
    }

    private async Task Complete(int id)
    {
        if (await OrderService.CompleteOrder(id))
        {
            var ord = orders.First(o => o.Id == id);
            ord.Status = "Completed";
            StateHasChanged();
        }
    }
}
