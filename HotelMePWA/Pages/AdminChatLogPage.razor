@page "/admin/chatlog"
@using HotelMe.Shared.Models
@inject ChatService ChatService
@inject AuthService AuthService
@inject AiService AiService

<MudText Typo="Typo.h5" Class="mb-4">💬 All Chat Messages</MudText>

@if (!isReady)
{
    <MudProgressCircular Indeterminate="true" Size="Size.Large" />
}
else if (!isAdmin)
{
    <MudAlert Severity="Severity.Error">⛔ Must be an Administrator.</MudAlert>
}
else if (messages.Count == 0)
{
    <MudText Color="Color.Secondary">No messages received.</MudText>
}
else
{
    <MudTable Items="messages" Striped="true" Hover="true">
        <HeaderContent>
            <MudTh>#</MudTh>
            <MudTh>User ID</MudTh>
            <MudTh>Message</MudTh>
            <MudTh>Sent At</MudTh>
            <MudTh>Checked-In?</MudTh>
            <MudTh>Room</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="#">@context.Id</MudTd>
            <MudTd DataLabel="User ID">@context.UserId</MudTd>
            <MudTd DataLabel="Message">

                <MudText>@context.Message</MudText>

                <MudButton Variant="Variant.Text"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.AutoAwesome"
                           OnClick="@(() => GenerateReplies(context))"
                           Class="mt-1">
                    AI replies
                </MudButton>

                @if (aiForMessageId == context.Id)
                {
                    if (isGeneratingReplies)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mt-1" />
                    }
                    else if (aiReplies.Any())
                    {
                        <MudPaper Class="pa-2 mt-1" Elevation="1">
                            <MudStack Spacing="1">
                                @foreach (var r in aiReplies)
                                {
                                    <MudText Typo="Typo.body2">• @r</MudText>
                                }
                            </MudStack>
                        </MudPaper>
                    }
                }

            </MudTd>
            <MudTd DataLabel="Sent At">@context.SentAt.ToLocalTime().ToString("g")</MudTd>
            <MudTd DataLabel="Checked-In?">
                @if (context.HasActiveBooking)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Close" />
                }
            </MudTd>
            <MudTd DataLabel="Room">
                @if (context.HasActiveBooking && !string.IsNullOrEmpty(context.RoomNumber))
                {
                    @context.RoomNumber
                }
                else
                {
                    <MudText Color="Color.Secondary">—</MudText>
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private bool isAdmin, isReady;
    private List<ChatMessage> messages = new();
    private int? aiForMessageId;
    private bool isGeneratingReplies;
    private List<string> aiReplies = new();


    protected override async Task OnInitializedAsync()
    {
        var role = await AuthService.GetUserRole();
        isAdmin = role == "Admin";

        if (isAdmin)
            messages = await ChatService.GetAllMessages();

        isReady = true;
    }

    private async Task GenerateReplies(ChatMessage msg)
    {
        aiForMessageId = msg.Id;
        isGeneratingReplies = true;
        aiReplies.Clear();

        aiReplies = await AiService.GetSmartReplies(
            guestMessage: msg.Message,
            roomNumber: msg.RoomNumber,
            guestName: null
        );

        isGeneratingReplies = false;
    }

}
